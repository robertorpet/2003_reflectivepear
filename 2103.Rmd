
2103 project code, Robert Orpet, 20 April, 2022
For: Reflective groundcovers implementation manuscript

Design: randomized complete block with three treatments (control, reflective fabric (= Extenday), metallized film (= mylar)). Blocks are plots next to each other in a pear orchard.

Sampling: there were pre-treatment and post-treatment samples. Each sample included multiple measurements on the same plot. There were multiple post-treatment samples through and multiple samples after treatments were removed.

Analysis approach: analyses were repeated with multiple approaches for comparison because there are multiple philosophies on use of random effects and mixed models.
Method 1. summarize repeated measures within plots with average, summarize repeated measures across time post-treatment as-needed with cumulative insect-days per day, use random effect for blocks. Uses glmmTMB()
Method 2. as method 1, but uses lme()
Method 3. as method 1, but fixed effect for block and uses aov()
Method 4. no summarizing, use random effects for plots nested within block, and use negative binomial distribution. Uses glmmTMB()


```{r Setup}

#Load packages
library(readxl)
library(ggplot2)
library(ggpubr)
library(glmmTMB)
library(DHARMa)
library(car)
library(emmeans)
library(nlme)

#Load data
Data_taps <- read_excel("2103 - data - taps.xlsx", skip = 9, guess_max = 10000)
Data_buds <- read_excel("2103 - data - buds.xlsx", skip = 9, guess_max = 10000)
Data_leaves <- read_excel("2103 - data - leaves.xlsx", skip = 9, guess_max = 10000)
Data_fruit <- read_excel("2103 - data - fruit.xlsx", skip = 0, guess_max = 10000)
Data_cards <- read_excel("2103 - data - cards.xlsx", skip = 9, guess_max = 10000)

#Data cleanup and labeling
#Rename treatment labels for visulizations
Data_taps$Trt <- factor(Data_taps$Trt,
                    levels=c("Control","Extenday","Mylar"),
                    labels=c("Control", "Reflective fabric","Metallized film"))
Data_buds$Trt <- factor(Data_buds$Trt,
                    levels=c("Control","Extenday","Mylar"),
                    labels=c("Control", "Reflective fabric","Metallized film"))
Data_leaves$Trt <- factor(Data_leaves$Trt,
                    levels=c("Control","Extenday","Mylar"),
                    labels=c("Control", "Reflective fabric","Metallized film"))
#average the repeated measures on plots within a sample day (e.g., calculate pear psylla adults per beat tray)
Data_taps_campy <- do.call(data.frame, 
             aggregate(Campy~Period+Date+Day+Block+Trt, 
                       data = Data_taps, 
                       function(x) 
                       c(mean = mean(x), 
                       count = length(x))))
Data_taps <- do.call(data.frame, 
             aggregate(PP~Period+Date+Day+Block+Trt, 
                       data = Data_taps, 
                       function(x) 
                       c(mean = mean(x), 
                       count = length(x))))
Data_buds <- do.call(data.frame, 
             aggregate(cbind(Wood.eggs,Top.eggs,Nymph.small,Nymph.big)~Period+Date+Day+Block+Trt, 
                       data = Data_buds, 
                       function(x) 
                       c(mean = mean(x), 
                       count = length(x))))
Data_fruit <- do.call(data.frame,
              aggregate(cbind(Weight_g,Length_mm, Width_mm,Sunburn_percentarea)~Block+Treatment,
                        data = Data_fruit,
                        function(x)
                        c(mean = mean(x),
                        count = length(x),
                        sd = sd(x))))

#Theme for graphs
theme_new <- theme_set(theme_bw())
theme_new <- theme_update(
  plot.background = element_blank(),
  panel.grid.major = element_blank(),
  panel.grid.minor = element_blank(),
  axis.title.x = element_blank(),
  axis.text.x = element_text(color = 'black'),
  axis.text.y = element_text(color = 'black'),
  legend.position=c(1,1),
  legend.justification=c(1,0),
  legend.box="vertical",
  legend.direction='vertical',
  legend.box.margin=margin(0,0,0,0),
  legend.title = element_blank(),
  legend.key.size = unit(0.75, 'lines')
)
```

```{r Visualization: Fig. 3 Insect dynamics}

#Fig 3a (left): spring pear psylla adult from beat tray
adults <- ggplot((subset(Data_taps, Day < 135)), aes(x = Day, y = PP.mean, fill = Trt, shape = Trt, linetype = Trt, color = Trt)) +
  scale_fill_manual(values = c('black', 'white', 'grey')) +
  scale_color_manual(values = c('black', 'grey', 'black')) +
  scale_shape_manual(values = c(21,23,23)) +
  scale_linetype(guide = guide_legend(override.aes = list(alpha = 0) ) )+ #to make legend invisible
      #Reflective manual annotation
      geom_vline(xintercept = 76) +
      geom_text(aes(x = 76,y=13,label = "Installation"), vjust = "top", hjust = "right", angle = 90, size = 2.5,check_overlap = TRUE,show.legend = FALSE) +
      #Kaolin manual annotation
      geom_vline(xintercept = 75, color = "grey") + geom_vline(xintercept = 106, color = "grey") +
      geom_text(aes(x = c(75),y=13,label = "Kaolin"), vjust = "bottom",hjust = "right", color = 'grey', angle = 90, size = 2.5,check_overlap = TRUE,show.legend = FALSE) +
      geom_text(aes(x = c(106),y=13,label = "Kaolin"), vjust = "top",hjust = "right", color = 'grey', angle = 90, size = 2.5,check_overlap = TRUE,show.legend = FALSE) +
      #Oil manual annotation
      geom_vline(xintercept = 126, color = "grey") +
      geom_text(aes(x = 126,y=13,label = "Oil"),vjust = "top", hjust = "right", color = "grey", angle = 90, size = 2.5,check_overlap = TRUE,show.legend = FALSE) +
      stat_summary(fun = "mean", geom = "line") +
      stat_summary(fun.data = mean_se, geom = "errorbar", width = 0, linetype = 'solid') +
      stat_summary(fun = "mean", geom = "point") +
      scale_x_continuous("", limits = c(59,135), breaks = c(60,91,121), labels = c("1-Mar","1-Apr","1-May")) +
      scale_y_continuous("No. adults/tray")

#Fig 3b (left): pear psylla eggs from bud counts
eggs <- ggplot((Data_buds), aes(x = Day, y = (Wood.eggs.mean+Top.eggs.mean), fill = Trt, shape = Trt, linetype = Trt, color = Trt)) +
  scale_fill_manual(values = c('black', 'white', 'grey')) +
  scale_color_manual(values = c('black', 'grey', 'black')) +
  scale_shape_manual(values = c(21,23,23)) +
      geom_vline(xintercept = 76) +
      geom_vline(xintercept = 75, color = "grey") + geom_vline(xintercept = 106, color = "grey") +
      geom_vline(xintercept = 126, color = "grey") +
      stat_summary(fun = "mean", geom = "line") +
      stat_summary(fun.data = mean_se, geom = "errorbar", width = 0, linetype = 'solid') +
      stat_summary(fun = "mean", geom = "point") +
      scale_x_continuous("", limits = c(59,135), breaks = c(60,91,121), labels = c("1-Mar","1-Apr","1-May")) +
      scale_y_continuous("No. eggs/bud")

#Fig 3c (left) pear psylla nymphs from bud counts
nymphs <- ggplot((Data_buds), aes(x = Day, y = (Nymph.small.mean+Nymph.big.mean), fill = Trt, shape = Trt, linetype = Trt, color = Trt)) +
  scale_fill_manual(values = c('black', 'white', 'grey')) +
  scale_color_manual(values = c('black', 'grey', 'black')) +
  scale_shape_manual(values = c(21,23,23)) +
      geom_vline(xintercept = 76) +
      geom_vline(xintercept = 75, color = "grey") + geom_vline(xintercept = 106, color = "grey") +
      geom_vline(xintercept = 126, color = "grey") +
      stat_summary(fun = "mean", geom = "line") +
      stat_summary(fun.data = mean_se, geom = "errorbar", width = 0, linetype = 'solid') +
      stat_summary(fun = "mean", geom = "point") +
      scale_x_continuous("", limits = c(59,135), breaks = c(60,91,121), labels = c("1-Mar","1-Apr","1-May")) +
      scale_y_continuous("No. nymphs/bud")

#Fig. 3d (left): Campy bugs from beat tray taps in spring
campy <- ggplot((Data_taps_campy), aes(x = Day, y = Campy.mean, fill = Trt, shape = Trt, linetype = Trt, color = Trt)) +
  scale_fill_manual(values = c('black', 'white', 'grey')) +
  scale_color_manual(values = c('black', 'grey', 'black')) +
  scale_shape_manual(values = c(21,23,23)) +
      geom_vline(xintercept = 76) +
      geom_vline(xintercept = 75, color = "grey") + geom_vline(xintercept = 106, color = "grey") +
      geom_vline(xintercept = 126, color = "grey") +
      stat_summary(fun = "mean", geom = "line") +
      stat_summary(fun.data = mean_se, geom = "errorbar", width = 0, linetype = 'solid') +
      stat_summary(fun = "mean", geom = "point") +
      scale_x_continuous("", limits = c(59,135), breaks = c(60,91,121), labels = c("1-Mar","1-Apr","1-May")) +
      scale_y_continuous("No. campy/tray", limits = c(0,0.3), breaks = c(0.0,0.1,0.2,0.3))

#arrange Fig. 3 (left)
Fig2103_1a<-(ggarrange(
    adults + theme(legend.text = element_text(color = "transparent")),
    eggs,
    nymphs,
    campy,
    ncol = 1,
    labels = c("A","B","C","D"), vjust = c(-0.5,-0.5,-0.5),
    align="hv", common.legend = TRUE
    ))

#Fig. 3a (right) pear psylla adults from beat tray, summer through fall
adults <- ggplot((subset(Data_taps, Day > 135)), aes(x = Day, y = PP.mean, fill = Trt, shape = Trt, linetype = Trt, color = Trt)) +
  scale_fill_manual(values = c('black', 'white', 'grey')) +
  scale_color_manual(values = c('black', 'grey', 'black')) +
  scale_shape_manual(values = c(21,23,23)) +
      #manually annotate reflective
      geom_vline(xintercept = 220) + #reflective
      geom_text(aes(x = 220,y=9,label = "Removal"),vjust = "top", hjust = "right", angle = 90, size = 2.5,check_overlap = TRUE,show.legend = FALSE) +
      #Manually annotate Microna + oil spray
      geom_vline(xintercept = 137, color = "grey") + #Microna
      geom_vline(xintercept = c(137,230), color = "grey") + #oil or cinnerate alone
      geom_text(aes(x = 137,y=9,label = "CaCO[3] + oil"), parse = TRUE, color = 'grey',vjust = "top", hjust = "right", angle = 90, size = 2.5,check_overlap = TRUE,show.legend = FALSE) +
      geom_text(aes(x = 230,y=9,label = "Cinnamon oil"),color='grey',vjust = "top", hjust = "right", angle = 90, size = 2.5,check_overlap = TRUE,show.legend = FALSE) +
      #Manually annorate Neemix + oil sprays
      geom_vline(xintercept = c(145,160,188,215), color = "grey",) + #oil+Neemix
      geom_text(aes(x = 145,y=9,label = "Azadirachtin + oil"),color = "grey", vjust = "top", hjust = "right", angle = 90, size = 2.5,check_overlap = TRUE,show.legend = FALSE) +
      geom_text(aes(x = 160,y=9,label = "Azadirachtin + oil"),color = "grey",vjust = "top", hjust = "right", angle = 90, size = 2.5,check_overlap = TRUE,show.legend = FALSE) +
      geom_text(aes(x = 188,y=9,label = "Azadirachtin + oil"),color = "grey",vjust = "top", hjust = "right", angle = 90, size = 2.5,check_overlap = TRUE,show.legend = FALSE) +
      geom_text(aes(x = 215,y=9,label = "Azadirachtin + oil"),color = "grey",vjust = "top", hjust = "right", angle = 90, size = 2.5,check_overlap = TRUE,show.legend = FALSE) +
      stat_summary(fun = "mean", geom = "line") +
      stat_summary(fun.data = mean_se, geom = "errorbar", width = 0, linetype = 'solid') +
      stat_summary(fun = "mean", geom = "point") +
      scale_y_continuous("No. adults/tray") +
      scale_x_continuous("Date", limits = c(136,292),
                         breaks = c(152,182,213,244,274),
                         labels = c("1-Jun","1-Jul","1-Aug","1-Sep","1-Oct"))

#Fig. 3b (right): pear psylla eggs on leaves
eggs <- ggplot((subset(Data_leaves, Day > 135)), aes(x = Day, y = (Eggs/30), fill = Trt, shape = Trt, linetype = Trt, color = Trt)) +
  scale_fill_manual(values = c('black', 'white', 'grey')) +
  scale_color_manual(values = c('black', 'grey', 'black')) +
  scale_shape_manual(values = c(21,23,23)) +
      geom_vline(xintercept = 220) + #reflective
      geom_vline(xintercept = 137, color = "grey") + #Microna
      geom_vline(xintercept = c(137,230), color = "grey") + #oil or cinnerate alone
      geom_vline(xintercept = c(145,160,188,215), color = "grey") + #oil+Neemix    
  stat_summary(fun = "mean", geom = "line") +
      stat_summary(fun.data = mean_se, geom = "errorbar", width = 0, linetype = 'solid') +
      stat_summary(fun = "mean", geom = "point") +
  scale_x_continuous("Date", limits = c(136,292),
                         breaks = c(152,182,213,244,274),
                         labels = c("1-Jun","1-Jul","1-Aug","1-Sep","1-Oct")) +
      scale_y_continuous("No. eggs/leaf")

#Fig. 3c (right): pear psylla nymphs on leaves
nymphs <- ggplot((subset(Data_leaves, Day > 135)), aes(x = Day, y = ((Small+Big)/30), fill = Trt, shape = Trt, linetype = Trt, color = Trt)) +
  scale_fill_manual(values = c('black', 'white', 'grey')) +
  scale_color_manual(values = c('black', 'grey', 'black')) +
  scale_shape_manual(values = c(21,23,23)) +
      geom_vline(xintercept = 220) + #reflective
      geom_vline(xintercept = 137, color = "grey") + #Microna
      geom_vline(xintercept = c(137,230), color = "grey") + #oil or cinnerate alone
      geom_vline(xintercept = c(145,160,188,215), color = "grey") + #oil+Neemix
  stat_summary(fun = "mean", geom = "line") +
      stat_summary(fun.data = mean_se, geom = "errorbar", width = 0, linetype = 'solid') +
      stat_summary(fun = "mean", geom = "point") +
  scale_x_continuous("Date", limits = c(136,292),
                         breaks = c(152,182,213,244,274),
                         labels = c("1-Jun","1-Jul","1-Aug","1-Sep","1-Oct")) +
      scale_y_continuous("No. nymphs/leaf")

#Fig 3d (right): campy bugs from beat trays summer through fall
campy <- ggplot((subset(Data_taps_campy, Day > 135)), aes(x = Day, y = Campy.mean, fill = Trt, shape = Trt, linetype = Trt, color = Trt)) +
  scale_fill_manual(values = c('black', 'white', 'grey')) +
  scale_color_manual(values = c('black', 'grey', 'black')) +
  scale_shape_manual(values = c(21,23,23)) +
      geom_vline(xintercept = 220) + #reflective
      geom_vline(xintercept = 137, color = "grey") + #Microna
      geom_vline(xintercept = c(137,230), color = "grey") + #oil or cinnerate alone
      geom_vline(xintercept = c(145,160,188,215), color = "grey") + #oil+Neemix
  stat_summary(fun = "mean", geom = "line") +
      stat_summary(fun.data = mean_se, geom = "errorbar", width = 0, linetype = 'solid') +
      stat_summary(fun = "mean", geom = "point") +
  scale_x_continuous("Date", limits = c(136,292),
                         breaks = c(152,182,213,244,274),
                         labels = c("1-Jun","1-Jul","1-Aug","1-Sep","1-Oct")) +
      scale_y_continuous("No. campy/tray", limits = c(0,0.3), breaks = c(0.0,0.1,0.2,0.3))

#Arrange Fig. 3 (right)
  Fig2103_1b <- (ggarrange(
    adults,
    eggs,
    nymphs,
    campy,
    ncol = 1,
    align="hv",common.legend = TRUE
    ))

#Arrange full Fig. 3
Fig2103_full <- ggarrange(
  Fig2103_1a,
  Fig2103_1b,
  widths = c(0.5, 1)
)

#Save figure output
ggsave(plot = Fig2103_full, file = "Fig3.png", width = 17, height = 16, unit = "cm")

```

```{r Summarization: Calculate pear psylla and campylomma insect-days}

#Calculate cumulative insect days - adult taps
#________________________________________________
#Build blank data frame
CID_output <- data.frame(Season=character(), 
                         Block=character(), 
                         Treatment=character(), 
                         CID=numeric(), 
                         Days_sum=numeric())
Data_taps$ID <- paste(Data_taps$Period,Data_taps$Block,Data_taps$Trt,sep = "_")  #Make a unique identifer for each experimental unit by Period of study
IDs <- unique(Data_taps$ID)                                     #Get a list of the IDs
for (value in IDs) {                                            #loop for each ID
  Data_taps_subset <- subset(Data_taps, ID == value)
  row.names(Data_taps_subset) <- NULL
  for (row in 1:nrow(Data_taps_subset)) {                          #loop to calculate within each ID
    if(row == 1){
      Insect_avg <- NA
      Days_difference <- NA
      Insectdays <- 0
      Days <- 0
      output <- data.frame(Insectdays,Days)
    }
    #pre-sample was only one date, so use the point data instead of trying to calculate CIDs
    if(unique(Data_taps_subset$Period == "Pre")){
      Days <- 1
      Insectdays <- Data_taps_subset[row,"PP.mean"]
      output <- data.frame(Insectdays,Days)
    }
    if(row > 1){
    Insect_current <- Data_taps_subset[row,"PP.mean"]
    Insect_previous <- Data_taps_subset[(row-1),"PP.mean"]
    Insect_avg <- (Insect_current + Insect_previous) / 2
    Day_current <- as.numeric(Data_taps_subset[row,"Day"])
    Day_previous <- as.numeric(Data_taps_subset[row-1,"Day"])
    if(Day_current < Day_previous){                             #check for out-of-order dates
      print("Error: Days not sorted chronologically")
      print(value)
    }
    Days <- Day_current - Day_previous
    Insectdays <- Insect_avg*Days
    newrow <- data.frame(Insectdays,Days)
    output <- rbind(output, newrow)
    }
  }
  Season <- unique(Data_taps_subset$Period)
  Block <- unique(Data_taps_subset$Block)
  Treatment <- unique(Data_taps_subset$Trt)
  CID <- sum(output$Insectdays)
  Days_sum <- sum(output$Days)
  CID_newrow <- data.frame(Season,Block, Treatment, CID, Days_sum)
  CID_output <- rbind(CID_output, CID_newrow)
}

#Calculate cumulative insect days - campy taps
#________________________________________________
#Build blank data frame
CID_output_campy <- data.frame(Season=character(), 
                         Block=character(), 
                         Treatment=character(), 
                         CID=numeric(), 
                         Days_sum=numeric())
Data_taps_campy$ID <- paste(Data_taps_campy$Period,Data_taps_campy$Block,Data_taps_campy$Trt,sep = "_")  #Make a unique identifer for each experimental unit by Period of study
IDs <- unique(Data_taps_campy$ID)                               #Get a list of the IDs
for (value in IDs) {                                            #loop for each ID
  Data_taps_campy_subset <- subset(Data_taps_campy, ID == value)
  row.names(Data_taps_campy_subset) <- NULL
  for (row in 1:nrow(Data_taps_campy_subset)) {                       #loop to calculate within each ID
    if(row == 1){
      Insect_avg <- NA
      Days_difference <- NA
      Insectdays <- 0
      Days <- 0
      output <- data.frame(Insectdays,Days)
    }
    #pre-sample was only one date, so use the point data instead of trying to calculate CIDs
    if(unique(Data_taps_campy_subset$Period == "Pre")){
      Days <- 1
      Insectdays <- Data_taps_campy_subset[row,"Campy.mean"]
      output <- data.frame(Insectdays,Days)
    }
    if(row > 1){
    Insect_current <- Data_taps_campy_subset[row,"Campy.mean"]
    Insect_previous <- Data_taps_campy_subset[(row-1),"Campy.mean"]
    Insect_avg <- (Insect_current + Insect_previous) / 2
    Day_current <- as.numeric(Data_taps_campy_subset[row,"Day"])
    Day_previous <- as.numeric(Data_taps_campy_subset[row-1,"Day"])
    if(Day_current < Day_previous){                             #check for out-of-order dates
      print("Error: Days not sorted chronologically")
      print(value)
    }
    Days <- Day_current - Day_previous
    Insectdays <- Insect_avg*Days
    newrow <- data.frame(Insectdays,Days)
    output <- rbind(output, newrow)
    }
  }
  Season <- unique(Data_taps_campy_subset$Period)
  Block <- unique(Data_taps_campy_subset$Block)
  Treatment <- unique(Data_taps_campy_subset$Trt)
  CID <- sum(output$Insectdays)
  Days_sum <- sum(output$Days)
  CID_newrow <- data.frame(Season,Block, Treatment, CID, Days_sum)
  CID_output_campy <- rbind(CID_output_campy, CID_newrow)
}

#Calculate cumulative insect days - bud counts (eggs, nymphs)
#____________________________________________________
CID_output_buds <- data.frame(Season=character(), 
                         Block=character(), 
                         Treatment=character(), 
                         CID_egg=numeric(), 
                         CID_nymph=numeric(), 
                         Days_sum=numeric())
Data_CIDcalc <- Data_buds
Data_CIDcalc$ID <- paste(Data_CIDcalc$Period,Data_CIDcalc$Block,Data_CIDcalc$Trt,sep = "_")  #Make a unique identifer for each experimental unit by Period of study
IDs <- unique(Data_CIDcalc$ID)                                     #Get a list of the IDs
for (value in IDs) {                                            #loop for each ID
  Data_CIDcalc_subset <- subset(Data_CIDcalc, ID == value)
  row.names(Data_CIDcalc_subset) <- NULL
  for (row in 1:nrow(Data_CIDcalc_subset)) {                          #loop to calculate within each ID
    if(row == 1){
      Egg_avg <- NA
      Nymph_avg <- NA
      Days_difference <- NA
      Eggdays <- 0
      Nymphdays <- 0
      Days <- 0
      output <- data.frame(Eggdays,Nymphdays,Days)
    }
    else{
    Egg_current <- (Data_CIDcalc_subset[row,"Wood.eggs.mean"] + Data_CIDcalc_subset[row,"Top.eggs.mean"])
    Egg_previous <- Data_CIDcalc_subset[(row-1),"Wood.eggs.mean"] + Data_CIDcalc_subset[row-1,"Top.eggs.mean"]
    Egg_avg <- (Egg_current + Egg_previous) / 2
    Nymph_current <- Data_CIDcalc_subset[row,"Nymph.small.mean"] + Data_CIDcalc_subset[row,"Nymph.big.mean"]
    Nymph_previous <- Data_CIDcalc_subset[(row-1),"Nymph.small.mean"] + Data_CIDcalc_subset[row-1,"Nymph.big.mean"]
    Nymph_avg <- (Nymph_current + Nymph_previous) / 2
    Day_current <- as.numeric(Data_CIDcalc_subset[row,"Day"])
    Day_previous <- as.numeric(Data_CIDcalc_subset[row-1,"Day"])
    if(Day_current < Day_previous){                             #check for out-of-order dates
      print("Error: Days not sorted chronologically")
      print(value)
    }
    Days <- Day_current - Day_previous
    Eggdays <- Egg_avg*Days
    Nymphdays <- Nymph_avg*Days
    newrow <- data.frame(Eggdays,Nymphdays,Days)
    output <- rbind(output, newrow)
    }
  }
  Season <- unique(Data_CIDcalc_subset$Period)
  Block <- unique(Data_CIDcalc_subset$Block)
  Treatment <- unique(Data_CIDcalc_subset$Trt)
  CID_egg <- sum(output$Eggdays)
  CID_nymph <- sum(output$Nymphdays)
  Days_sum <- sum(output$Days)
  CID_newrow <- data.frame(Season,Block, Treatment, CID_egg, CID_nymph, Days_sum)
  CID_output_buds <- rbind(CID_output_buds, CID_newrow)
}

#Calculate cumulative insect days - leaf counts (eggs, nymphs)
#____________________________________________________________
CID_output_leaf <- data.frame(Season=character(), 
                         Block=character(), 
                         Treatment=character(), 
                         CID_egg=numeric(), 
                         CID_nymph=numeric(),
                         CID_tsm=numeric(),
                         Days_sum=numeric())
Data_CIDcalc <- Data_leaves
Data_CIDcalc$ID <- paste(Data_CIDcalc$Period,Data_CIDcalc$Block,Data_CIDcalc$Trt,sep = "_")  #Make a unique identifer for each experimental unit by Period of study
IDs <- unique(Data_CIDcalc$ID)                                     #Get a list of the IDs
for (value in IDs) {                                            #loop for each ID
  Data_CIDcalc_subset <- subset(Data_CIDcalc, ID == value)
  row.names(Data_CIDcalc_subset) <- NULL
  for (row in 1:nrow(Data_CIDcalc_subset)) {                          #loop to calculate within each ID
    if(row == 1){
      Egg_avg <- NA
      Nymph_avg <- NA
      tsm_avg <- NA
      Days_difference <- NA
      Eggdays <- 0
      Nymphdays <- 0
      tsmdays <- 0
      Days <- 0
      output <- data.frame(Eggdays,Nymphdays,tsmdays,Days)
    }
    else{
    Egg_current <-Data_CIDcalc_subset[row,"Eggs"]
    Egg_previous <- Data_CIDcalc_subset[(row-1),"Eggs"]
    Egg_avg <- (Egg_current + Egg_previous) / 2
    Nymph_current <- Data_CIDcalc_subset[row,"Small"] + Data_CIDcalc_subset[row,"Big"]
    Nymph_previous <- Data_CIDcalc_subset[(row-1),"Small"] + Data_CIDcalc_subset[row-1,"Big"]
    Nymph_avg <- (Nymph_current + Nymph_previous) / 2
    tsm_current <- Data_CIDcalc_subset[row,"TSM"] + Data_CIDcalc_subset[row,"TSM"]
    tsm_previous <- Data_CIDcalc_subset[(row-1),"TSM"] + Data_CIDcalc_subset[row-1,"TSM"]
    tsm_avg <- (tsm_current + tsm_previous) / 2
    Day_current <- as.numeric(Data_CIDcalc_subset[row,"Day"])
    Day_previous <- as.numeric(Data_CIDcalc_subset[row-1,"Day"])
    if(Day_current < Day_previous){                             #check for out-of-order dates
      print("Error: Days not sorted chronologically")
      print(value)
    }
    Days <- Day_current - Day_previous
    Eggdays <- Egg_avg*Days
    Nymphdays <- Nymph_avg*Days
    tsmdays <- tsm_avg*Days
    newrow <- data.frame(Eggdays,Nymphdays,tsmdays, Days)
    colnames(newrow) <- c('Eggdays','Nymphdays','tsmdays','Days')
    output <- rbind(output, newrow)
    }
  }
  Season <- unique(Data_CIDcalc_subset$Period)
  Block <- unique(Data_CIDcalc_subset$Block)
  Treatment <- unique(Data_CIDcalc_subset$Trt)
  CID_egg <- sum(output$Eggdays)
  CID_nymph <- sum(output$Nymphdays)
  CID_tsm <- sum(output$tsmdays)
  Days_sum <- sum(output$Days)
  CID_newrow <- data.frame(Season,Block, Treatment, CID_egg, CID_nymph, CID_tsm, Days_sum)
  CID_output_leaf <- rbind(CID_output_leaf, CID_newrow)
}
```

```{r Summarization: Calculate cumulative trap days for sticky cards}

#Subset spring and summer-fall sampling periods
Data_cards_spring <- subset(Data_cards, Collected_day < 220) #data from June 16 up to August 8 (reflective removal day; last card for this period is Aug 6)
Data_cards_fall <- subset(Data_cards, Collected_day > 220) #data from August 8 to October 4

#Take the spring sum of insect counts per taxon for each experimental unit
Data_cards_spring_cumulative <- do.call(data.frame, aggregate(cbind(
  PP,
  Trech,
  Derae,
  Campy,
  Casey,
  Twospot,
  Conv,
  Spotless,
  Black,
  Anthocoris,
  Orius,
  Days)
  ~Block+Trt, 
  data = Data_cards_spring, 
  function(x) 
  c(sum = sum(x))))

#Combine coccinellidae
Data_cards_spring_cumulative$Coccinellidae <- (Data_cards_spring_cumulative$Casey +
                                                 Data_cards_spring_cumulative$Twospot +
                                                 Data_cards_spring_cumulative$Conv +
                                                 Data_cards_spring_cumulative$Spotless)

#Combine anthocoridae
Data_cards_spring_cumulative$Anthocoridae <- (Data_cards_spring_cumulative$Anthocoris +
                                                 Data_cards_spring_cumulative$Orius)

#Take the summer sum of insect counts per taxon for each experimental unit
Data_cards_fall_cumulative <- do.call(data.frame, aggregate(cbind(
  PP,
  Trech,
  Derae,
  Campy,
  Casey,
  Twospot,
  Conv,
  Spotless,
  Black,
  Anthocoris,
  Orius,
  Days)
  ~Block+Trt, 
  data = Data_cards_fall, 
  function(x) 
  c(sum = sum(x))))
Data_cards_fall_cumulative$Coccinellidae <- (Data_cards_fall_cumulative$Casey +
                                                 Data_cards_fall_cumulative$Twospot +
                                                 Data_cards_fall_cumulative$Conv +
                                                 Data_cards_fall_cumulative$Spotless)
Data_cards_fall_cumulative$Anthocoridae <- (Data_cards_fall_cumulative$Anthocoris +
                                                 Data_cards_fall_cumulative$Orius)
```

```{r Analysis: Table 2 pear psylla adult beat tray tap data}

#plot pear psylla adult cumulative insect days by sampling period (pre-installation, spring, summer, fall)
ggplot(CID_output, aes(x = Treatment, y = CID)) +
  geom_point() +
  facet_wrap(~Season)

#METHOD FOR PUBLICATION: 3

##Method 1a. summary data, no transform, random block. diagnostics good
##significant results: spring (control highest), summer (r. fab. lowest)
for (test in unique(CID_output$Season)) {
  print("adults")
  Data_test <- subset(CID_output, Season == test)
  model <- glmmTMB(formula = CID ~ Treatment + (1|Block), data = Data_test)
  plot(simulateResiduals(model))
  print(test)
  print(Anova(model))
  print(emmeans(model, list(pairwise ~ Treatment), adjust = "tukey"))
}

##Method 1b. summary data, log transform, random block. diagnostics good
##significant results: same as method 1a
for (test in unique(CID_output$Season)) {
  print("adults")
  Data_test <- subset(CID_output, Season == test)
  model <- glmmTMB(formula = log(CID) ~ Treatment + (1|Block), data = Data_test)
  plot(simulateResiduals(model))
  print(test)
  print(Anova(model))
  print(emmeans(model, list(pairwise ~ Treatment), adjust = "tukey"))
}

##Method 2. summary data, log transform, random block. 
##significant results: same as method 1a
for (test in unique(CID_output$Season)) {
  print("adults")
  Data_test <- subset(CID_output, Season == test)
  model <- lme(log(CID) ~ Treatment, random = ~1|Block, data = Data_test, method = "REML")
  plot(model)
  qqnorm(resid(model))
  print(test)
  print(anova(model))
  print(emmeans(model, list(pairwise ~ Treatment), adjust = "tukey"))
}

##Method 2. summary data, log transform, random block. 
##significant results: same as method 1a
for (test in unique(CID_output$Season)) {
  print("adults")
  Data_test <- subset(CID_output, Season == test)
  model <- lme(log(CID) ~ Treatment, random = ~1|Block, data = Data_test, method = "REML")
  plot(model)
  qqnorm(resid(model))
  print(test)
  print(anova(model))
  print(emmeans(model, list(pairwise ~ Treatment), adjust = "tukey"))
}

#Method 3. summary data, no transform, fixed block.
##significant results: same as method 1a
for (test in unique(CID_output$Season)) {
  print("adults")
  print(test)
  Data_test <- subset(CID_output, Season == test)
  model <- aov(log(CID) ~ Treatment + Block, data = Data_test)
  print(summary(model))
  print(emmeans(model, list(pairwise ~ Treatment), adjust = "tukey"))
  plot(model, 1)
  plot(model, 2)
}

#Method 4. No summary, random block, nbinom1
Data_taps <- read_excel("2103 - data - taps.xlsx", skip = 9, guess_max = 10000)
for (test in unique(Data_taps$Period)) {
  Data_test <- subset(Data_taps, Period == test)
  model <- glmmTMB(formula = PP ~ Trt + (1|Block/Trt), family = 'nbinom1', data = Data_test)
plot(simulateResiduals(model))
print(Anova(model))
print(emmeans(model, list(pairwise ~ Trt), adjust = "tukey"))
}

#summary with SEM for table
Data_taps_analyzed <- do.call(data.frame, 
                          aggregate(CID/Days_sum~Season+Treatment, 
                                    data = CID_output, 
                                    function(x) 
                                    c(mean = mean(x), 
                                      count = length(x),
                                      SEM = sd(x)/sqrt(length(x)))))

```

```{r Analysis: Table 2 pear psylla egg counts spring}

#Plot of pear psylla egg cumulative insect-days for spring bud counts
ggplot(CID_output_buds, aes(x = Treatment, y = CID_egg, color = Block)) +
  geom_point() +
  facet_wrap(~Season)

#METHOD FOR PUBLICATION: 3a

#Method 1a. summary data, no transform, random block
#significant results: no fit, model convergence problem
Data_test <- CID_output_buds
model <- glmmTMB(formula = CID_egg ~ Treatment + (1|Block), data = Data_test)
plot(simulateResiduals(model))
print(Anova(model))
print(emmeans(model, list(pairwise ~ Treatment), adjust = "tukey"))

#Method 1b. summary data, log transform, random block. P = 0.03
Data_test <- CID_output_buds
model <- glmmTMB(formula = log(CID_egg) ~ Treatment + (1|Block), data = Data_test)
plot(simulateResiduals(model))
print(Anova(model))
print(emmeans(model, list(pairwise ~ Treatment), adjust = "tukey"))

#Method 2. summary data, log transform, random block. P = 0.15
Data_test <- CID_output_buds
model <- lme(log(CID_egg) ~ Treatment, random = ~1|Block, data = Data_test, method = "REML")
plot(model)
qqnorm(resid(model))
print(anova(model))
print(emmeans(model, list(pairwise ~ Treatment), adjust = "tukey"))

#Method 3a. summary data, no transform, fixed block. P = 0.16
Data_test <- CID_output_buds
model <- aov((CID_egg) ~ Treatment + Block, data = Data_test)
summary(model)
print(emmeans(model, list(pairwise ~ Treatment), adjust = "tukey"))
plot(model, 1)
plot(model, 2)

#Method 3b. summary data, log transform, fixed block. P = 0.21
Data_test <- CID_output_buds
model <- aov(log(CID_egg) ~ Treatment + Block, data = Data_test)
summary(model)
print(emmeans(model, list(pairwise ~ Treatment), adjust = "tukey"))
plot(model, 1)
plot(model, 2)

#Method 4. No summary, random block, nbinom1. P = 0.028
Data_buds <- read_excel("2103 - data - buds.xlsx", skip = 9, guess_max = 10000)
Data_test <- Data_buds
Data_test$eggs <- Data_test$Wood.eggs + Data_test$Top.eggs
model <- glmmTMB(formula = eggs ~ Trt + (1|Block/Trt), family = 'nbinom1', data = Data_test)
plot(simulateResiduals(model))
print(Anova(model))
print(emmeans(model, list(pairwise ~ Trt), adjust = "tukey"))

```

```{r Analysis: Table 2 pear psylla egg counts summer & fall}

#Plot of pear psylla egg cumulative insect-days for spring bud counts
ggplot(CID_output_leaf, aes(x = Treatment, y = CID_egg, color = Block)) +
  geom_point() +
  facet_wrap(~Season)

#METHOD FOR PUBLICATION: 3a

#Method 1a. summary data, no transform, random block
#model convergence problem
for (test in unique(CID_output_leaf$Season)) {
print(test)
Data_test <- subset(CID_output_leaf, Season == test)
model <- glmmTMB(formula = CID_egg ~ Treatment + (1|Block), data = Data_test)
plot(simulateResiduals(model))
print(Anova(model))
print(emmeans(model, list(pairwise ~ Treatment), adjust = "tukey"))
}

#Method 1b. summary data, log transform, random block
#summer P = 0.007, fall P = 0.11
for (test in unique(CID_output_leaf$Season)) {
print(test)
Data_test <- subset(CID_output_leaf, Season == test)
model <- glmmTMB(formula = log(CID_egg) ~ Treatment + (1|Block), data = Data_test)
plot(simulateResiduals(model))
print(Anova(model))
print(emmeans(model, list(pairwise ~ Treatment), adjust = "tukey"))
}

#Method 2. summary data, log transform, random block, lme
#summer P = 0.09, fall P = 0.27
for (test in unique(CID_output_leaf$Season)) {
print(test)
Data_test <- subset(CID_output_leaf, Season == test)
model <- lme(log(CID_egg) ~ Treatment, random = ~1|Block, data = Data_test, method = "REML")
plot(model)
qqnorm(resid(model))
print(anova(model))
print(emmeans(model, list(pairwise ~ Treatment), adjust = "tukey"))
}

#Method 3a. summary data, no transform, fixed block.
#results: summer P = 0.2, fall P = 0.5
for (test in unique(CID_output_leaf$Season)) {
print(test)
Data_test <- subset(CID_output_leaf, Season == test)
model <- aov((CID_egg) ~ Treatment + Block, data = Data_test)
print(summary(model))
print(emmeans(model, list(pairwise ~ Treatment), adjust = "tukey"))
plot(model, 1)
plot(model, 2)
}

#Method 3b. summary data, log transform, fixed block.
#results: summer P = 0.14, fall P = 0.27
for (test in unique(CID_output_leaf$Season)) {
print(test)
Data_test <- subset(CID_output_leaf, Season == test)
model <- aov(log(CID_egg) ~ Treatment + Block, data = Data_test)
print(summary(model))
print(emmeans(model, list(pairwise ~ Treatment), adjust = "tukey"))
plot(model, 1)
plot(model, 2)
}

#Method 4. No summary, random block, nbinom1
#summer P = 0.007 (Extenday < ctrl & m. film), fall P = 0.64
Data_leaves <- read_excel("2103 - data - leaves.xlsx", skip = 9, guess_max = 10000)
for (test in unique(Data_leaves$Period)) {
Data_test <- subset(Data_leaves, Period == test)
print(test)
model <- glmmTMB(formula = Eggs ~ Trt + (1|Block/Trt), family = 'nbinom2', data = Data_test)
plot(simulateResiduals(model))
print(Anova(model))
print(emmeans(model, list(pairwise ~ Trt), adjust = "tukey"))
}


```

```{r Analysis: Table 2 pear psylla nymph counts spring}

#Plot of pear psylla nymph cumulative insect-days for spring bud counts
ggplot(CID_output_buds, aes(x = Treatment, y = CID_nymph, color = Block)) +
  geom_point() +
  facet_wrap(~Season)

#METHOD FOR PUBLICATION: 3b

#Method 1a. summary data, no transform, random block. Poor fit
Data_test <- CID_output_buds
model <- glmmTMB(formula = CID_nymph ~ Treatment + (1|Block), data = Data_test)
plot(simulateResiduals(model))
print(Anova(model))
print(emmeans(model, list(pairwise ~ Treatment), adjust = "tukey"))

#Method 1b. summary data, log transform, random block. P = 0.08
Data_test <- CID_output_buds
model <- glmmTMB(formula = log(CID_nymph) ~ Treatment + (1|Block), data = Data_test)
plot(simulateResiduals(model))
print(Anova(model))
print(emmeans(model, list(pairwise ~ Treatment), adjust = "tukey"))

#Method 2. summary data, log transform, random block. P = 0.2
Data_test <- CID_output_buds
model <- lme(log(CID_nymph) ~ Treatment, random = ~1|Block, data = Data_test, method = "REML")
plot(model)
qqnorm(resid(model))
print(anova(model))
print(emmeans(model, list(pairwise ~ Treatment), adjust = "tukey"))

#Method 3a. summary data, no transform, fixed block. P = 0.5
Data_test <- CID_output_buds
model <- aov((CID_nymph) ~ Treatment + Block, data = Data_test)
summary(model)
print(emmeans(model, list(pairwise ~ Treatment), adjust = "tukey"))
plot(model, 1)
plot(model, 2)

#Method 3b. summary data, log transform, fixed block. P = 0.3
Data_test <- CID_output_buds
model <- aov(log(CID_nymph) ~ Treatment + Block, data = Data_test)
summary(model)
print(emmeans(model, list(pairwise ~ Treatment), adjust = "tukey"))
plot(model, 1)
plot(model, 2)

#Method 4. No summary, random block, nbinom1. P = 0.12
Data_buds <- read_excel("2103 - data - buds.xlsx", skip = 9, guess_max = 10000)
Data_test <- Data_buds
Data_test$nymphs <- Data_test$Nymph.small + Data_test$Nymph.big
model <- glmmTMB(formula = nymphs ~ Trt + (1|Block/Trt), family = 'nbinom2', data = Data_test)
plot(simulateResiduals(model))
print(Anova(model))
print(emmeans(model, list(pairwise ~ Trt), adjust = "tukey"))

```

```{r Analysis: Table 2 pear psylla nymph counts summer & fall}

#Plot of pear psylla nymph cumulative insect-days for spring bud counts
ggplot(CID_output_leaf, aes(x = Treatment, y = CID_nymph, color = Block)) +
  geom_point() +
  facet_wrap(~Season)

#METHOD FOR PUBLICATION: 3a

#Method 1a. summary data, no transform, random block. summer P = 0.4, fall P < 0.0001
for (test in unique(CID_output_leaf$Season)) {
print(test)
Data_test <- subset(CID_output_leaf, Season == test)
model <- glmmTMB(formula = CID_nymph ~ Treatment + (1|Block), data = Data_test)
plot(simulateResiduals(model))
print(Anova(model))
print(emmeans(model, list(pairwise ~ Treatment), adjust = "tukey"))
}

#Method 1b. summary data, log transform, random block. summer P=0.4, fall P<0.0001
for (test in unique(CID_output_leaf$Season)) {
print(test)
Data_test <- subset(CID_output_leaf, Season == test)
model <- glmmTMB(formula = log(CID_nymph) ~ Treatment + (1|Block), data = Data_test)
plot(simulateResiduals(model))
print(Anova(model))
print(emmeans(model, list(pairwise ~ Treatment), adjust = "tukey"))
}

#Method 2. summary data, log transform, random block, lme. summer P = 0.5, fall P = 0.02
for (test in unique(CID_output_leaf$Season)) {
print(test)
Data_test <- subset(CID_output_leaf, Season == test)
model <- lme(log(CID_nymph) ~ Treatment, random = ~1|Block, data = Data_test, method = "REML")
plot(model)
qqnorm(resid(model))
print(anova(model))
print(emmeans(model, list(pairwise ~ Treatment), adjust = "tukey"))
}

#Method 3a. summary data, no transform, fixed block. summer P = 0.6, fall P = 0.02
for (test in unique(CID_output_leaf$Season)) {
print(test)
Data_test <- subset(CID_output_leaf, Season == test)
model <- aov((CID_nymph) ~ Treatment + Block, data = Data_test)
print(summary(model))
print(emmeans(model, list(pairwise ~ Treatment), adjust = "tukey"))
plot(model, 1)
plot(model, 2)
}

#Method 3b. summary data, log transform, fixed block. summer P = 0.6, fall P = 0.02
for (test in unique(CID_output_leaf$Season)) {
print(test)
Data_test <- subset(CID_output_leaf, Season == test)
model <- aov(log(CID_nymph) ~ Treatment + Block, data = Data_test)
print(summary(model))
print(emmeans(model, list(pairwise ~ Treatment), adjust = "tukey"))
plot(model, 1)
plot(model, 2)
}

#Method 4. No summary, random block, nbinom2. summer P = 0.7, fall P = 0.8
Data_leaves <- read_excel("2103 - data - leaves.xlsx", skip = 9, guess_max = 10000)
Data_leaves$nymphs <- Data_leaves$Small + Data_leaves$Big
for (test in unique(Data_leaves$Period)) {
Data_test <- subset(Data_leaves, Period == test)
print(test)
model <- glmmTMB(formula = nymphs ~ Trt + (1|Block/Trt), family = 'nbinom1', data = Data_test)
plot(simulateResiduals(model))
print(Anova(model))
print(emmeans(model, list(pairwise ~ Trt), adjust = "tukey"))
}


```

```{r Analysis: Table 2 pest mites summer & fall}

#Plot of pest mite cumulative insect-days for summer leaf
ggplot(CID_output_leaf, aes(x = Treatment, y = CID_tsm, color = Block)) +
  geom_point() +
  facet_wrap(~Season)

#METHOD FOR PUBLICATION: 3b

#Method 1a. summary data, no transform, random block. model convergence problem.
for (test in unique(CID_output_leaf$Season)) {
print(test)
Data_test <- subset(CID_output_leaf, Season == test)
model <- glmmTMB(formula = CID_tsm ~ Treatment + (1|Block), data = Data_test)
plot(simulateResiduals(model))
print(Anova(model))
print(emmeans(model, list(pairwise ~ Treatment), adjust = "tukey"))
}

#Method 1b. summary data, log transform, random block. summer P = 0.6, fall P = 0.08
for (test in unique(CID_output_leaf$Season)) {
print(test)
Data_test <- subset(CID_output_leaf, Season == test)
model <- glmmTMB(formula = log(CID_tsm) ~ Treatment + (1|Block), data = Data_test)
plot(simulateResiduals(model))
print(Anova(model))
print(emmeans(model, list(pairwise ~ Treatment), adjust = "tukey"))
}

#Method 2. summary data, log transform, random block, lme. summer P = 0.7, fall P = 0.2
for (test in unique(CID_output_leaf$Season)) {
print(test)
Data_test <- subset(CID_output_leaf, Season == test)
model <- lme(log(CID_tsm) ~ Treatment, random = ~1|Block, data = Data_test, method = "REML")
plot(model)
qqnorm(resid(model))
print(anova(model))
print(emmeans(model, list(pairwise ~ Treatment), adjust = "tukey"))
}

#Method 3a. summary data, no transform, fixed block. summer P = 0.5, fall P = 0.3
for (test in unique(CID_output_leaf$Season)) {
print(test)
Data_test <- subset(CID_output_leaf, Season == test)
model <- aov((CID_tsm) ~ Treatment + Block, data = Data_test)
print(summary(model))
print(emmeans(model, list(pairwise ~ Treatment), adjust = "tukey"))
plot(model, 1)
plot(model, 2)
}

#Method 3b. summary data, log transform, fixed block. summer P = 0.7, fall P = 0.2
for (test in unique(CID_output_leaf$Season)) {
print(test)
Data_test <- subset(CID_output_leaf, Season == test)
model <- aov(log(CID_tsm) ~ Treatment + Block, data = Data_test)
print(summary(model))
print(emmeans(model, list(pairwise ~ Treatment), adjust = "tukey"))
plot(model, 1)
plot(model, 2)
}

#Method 4. No summary, random block, nbinom2. summer P = 0.9, fall P = 0.6
Data_leaves <- read_excel("2103 - data - leaves.xlsx", skip = 9, guess_max = 10000)
for (test in unique(Data_leaves$Period)) {
Data_test <- subset(Data_leaves, Period == test)
print(test)
model <- glmmTMB(formula = TSM ~ Trt + (1|Block/Trt), family = 'nbinom1', data = Data_test)
plot(simulateResiduals(model))
print(Anova(model))
print(emmeans(model, list(pairwise ~ Trt), adjust = "tukey"))
}
  
```

```{r Analysis: Campylomma taps}

#Plot of pest mite cumulative insect-days for summer leaf
ggplot(CID_output_campy, aes(x = Treatment, y = CID, color = Block)) +
  geom_point() +
  facet_wrap(~Season)

#summary with SEM for table
Data_taps_analyzed_campy <- do.call(data.frame, 
                          aggregate(CID/Days_sum~Treatment+Season, 
                                    data = CID_output_campy, 
                                    function(x) 
                                    c(mean = mean(x), 
                                      count = length(x),
                                      SEM = sd(x)/sqrt(length(x)))))

#remove seasons with too low campylomma counts. 
CID_output_campy <- subset(CID_output_campy, Season != "Pre") #no insects found
CID_output_campy <- subset(CID_output_campy, Season != "Spring") #no insects found
CID_output_campy <- subset(CID_output_campy, Season != "Fall") #only 4 insects found

#METHOD FOR PUBLICATION: 3b

#Method 1a. summary data, no transform, random block. P = 0.01
Data_test <- subset(CID_output_campy)
model <- glmmTMB(formula = CID ~ Treatment + (1|Block), data = Data_test)
plot(simulateResiduals(model))
print(Anova(model))
print(emmeans(model, list(pairwise ~ Treatment), adjust = "tukey"))

#Method 1b. summary data, log transform, random block. summer P = 0.03
Data_test <- subset(CID_output_campy)
model <- glmmTMB(formula = log(CID) ~ Treatment + (1|Block), data = Data_test)
plot(simulateResiduals(model))
print(Anova(model))
print(emmeans(model, list(pairwise ~ Treatment), adjust = "tukey"))

#Method 2. summary data, log transform, random block, lme. P = 0.14
Data_test <- subset(CID_output_campy)
model <- lme(log(CID) ~ Treatment, random = ~1|Block, data = Data_test, method = "REML")
plot(model)
qqnorm(resid(model))
print(anova(model))
print(emmeans(model, list(pairwise ~ Treatment), adjust = "tukey"))

#Method 3a. summary data, no transform, fixed block. summer P = 0.1
Data_test <- subset(CID_output_campy)
model <- aov((CID) ~ Treatment + Block, data = Data_test)
print(summary(model))
print(emmeans(model, list(pairwise ~ Treatment), adjust = "tukey"))
plot(model, 1)
plot(model, 2)

#Method 3b. summary data, log transform, fixed block. summer P = 0.2
Data_test <- subset(CID_output_campy)
model <- aov(log(CID) ~ Treatment + Block, data = Data_test)
print(summary(model))
print(emmeans(model, list(pairwise ~ Treatment), adjust = "tukey"))
plot(model, 1)
plot(model, 2)

#Method 4. No summary, random block, nbinom1. Model convergence problem. Too many zeros?
Data_test <- read_excel("2103 - data - taps.xlsx", skip = 9, guess_max = 10000)
model <- glmmTMB(formula = Campy ~ Trt + (1|Block/Trt), family = 'nbnom1', data = Data_test)
plot(simulateResiduals(model))
print(Anova(model))
print(emmeans(model, list(pairwise ~ Trt), adjust = "tukey"))



```

```{r Analysis: Table 4 Fruit data}

#Summary for table
Data_fruitsummary <- do.call(data.frame, 
             aggregate(cbind(Weight_g.mean,
                             Length_mm.mean,
                             Width_mm.mean,
                             Sunburn_percentarea.mean)
                             ~Treatment, 
                       data = Data_fruit, 
                       function(x) 
                       c(mean = mean(x), 
                       count = length(x),
                       SEM = sd(x)/sqrt(length(x)))))

#METHOD FOR PUBLICATION: 3a

#Method 1a. summary data, no transform, random block. All P > 0.1
Data_test <- Data_fruit

model <- glmmTMB(formula = Weight_g.mean ~ Treatment + (1|Block), data = Data_test)
plot(simulateResiduals(model))
print(Anova(model))
print(emmeans(model, list(pairwise ~ Treatment), adjust = "tukey"))
model <- glmmTMB(formula = Length_mm.mean ~ Treatment + (1|Block), data = Data_test)
plot(simulateResiduals(model))
print(Anova(model))
print(emmeans(model, list(pairwise ~ Treatment), adjust = "tukey"))
model <- glmmTMB(formula = Width_mm.mean ~ Treatment + (1|Block), data = Data_test)
plot(simulateResiduals(model))
print(Anova(model))
print(emmeans(model, list(pairwise ~ Treatment), adjust = "tukey"))
model <- glmmTMB(formula = Sunburn_percentarea.mean ~ Treatment + (1|Block), data = Data_test)
plot(simulateResiduals(model))
print(Anova(model))
print(emmeans(model, list(pairwise ~ Treatment), adjust = "tukey"))

#Method 1b. summary data, log transform, random block. All P > 0.1
Data_test <- Data_fruit

model <- glmmTMB(formula = log(Weight_g.mean) ~ Treatment + (1|Block), data = Data_test)
plot(simulateResiduals(model))
print(Anova(model))
print(emmeans(model, list(pairwise ~ Treatment), adjust = "tukey"))
model <- glmmTMB(formula = log(Length_mm.mean) ~ Treatment + (1|Block), data = Data_test)
plot(simulateResiduals(model))
print(Anova(model))
print(emmeans(model, list(pairwise ~ Treatment), adjust = "tukey"))
model <- glmmTMB(formula = log(Width_mm.mean) ~ Treatment + (1|Block), data = Data_test)
plot(simulateResiduals(model))
print(Anova(model))
print(emmeans(model, list(pairwise ~ Treatment), adjust = "tukey"))
model <- glmmTMB(formula = log(Sunburn_percentarea.mean) ~ Treatment + (1|Block), data = Data_test)
plot(simulateResiduals(model))
print(Anova(model))
print(emmeans(model, list(pairwise ~ Treatment), adjust = "tukey"))

#Method 2. summary data, no transform, random block, lme. P = 0.14
Data_test <- Data_fruit

model <- lme((Weight_g.mean) ~ Treatment, random = ~1|Block, data = Data_test, method = "REML")
plot(model)
qqnorm(resid(model))
print(anova(model))
print(emmeans(model, list(pairwise ~ Treatment), adjust = "tukey"))
model <- lme((Length_mm.mean) ~ Treatment, random = ~1|Block, data = Data_test, method = "REML")
plot(model)
qqnorm(resid(model))
print(anova(model))
print(emmeans(model, list(pairwise ~ Treatment), adjust = "tukey"))
model <- lme((Width_mm.mean) ~ Treatment, random = ~1|Block, data = Data_test, method = "REML")
plot(model)
qqnorm(resid(model))
print(anova(model))
print(emmeans(model, list(pairwise ~ Treatment), adjust = "tukey"))
model <- lme((Sunburn_percentarea.mean) ~ Treatment, random = ~1|Block, data = Data_test, method = "REML")
plot(model)
qqnorm(resid(model))
print(anova(model))
print(emmeans(model, list(pairwise ~ Treatment), adjust = "tukey"))

#Method 3a. summary data, no transform, fixed block. All P > 0.1
Data_test <- Data_fruit

model <- aov((Weight_g.mean) ~ Treatment + Block, data = Data_test)
print(summary(model))
print(emmeans(model, list(pairwise ~ Treatment), adjust = "tukey"))
plot(model, 1)
plot(model, 2)
model <- aov((Length_mm.mean) ~ Treatment + Block, data = Data_test)
print(summary(model))
print(emmeans(model, list(pairwise ~ Treatment), adjust = "tukey"))
plot(model, 1)
plot(model, 2)
model <- aov((Width_mm.mean) ~ Treatment + Block, data = Data_test)
print(summary(model))
print(emmeans(model, list(pairwise ~ Treatment), adjust = "tukey"))
plot(model, 1)
plot(model, 2)
model <- aov((Sunburn_percentarea.mean) ~ Treatment + Block, data = Data_test)
print(summary(model))
print(emmeans(model, list(pairwise ~ Treatment), adjust = "tukey"))
plot(model, 1)
plot(model, 2)

#Method 3b. summary data, log transform, fixed block. all P > 0.1
Data_test <- Data_fruit

model <- aov(log(Weight_g.mean) ~ Treatment + Block, data = Data_test)
print(summary(model))
print(emmeans(model, list(pairwise ~ Treatment), adjust = "tukey"))
plot(model, 1)
plot(model, 2)
model <- aov(log(Length_mm.mean) ~ Treatment + Block, data = Data_test)
print(summary(model))
print(emmeans(model, list(pairwise ~ Treatment), adjust = "tukey"))
plot(model, 1)
plot(model, 2)
model <- aov(log(Width_mm.mean) ~ Treatment + Block, data = Data_test)
print(summary(model))
print(emmeans(model, list(pairwise ~ Treatment), adjust = "tukey"))
plot(model, 1)
plot(model, 2)
model <- aov(log(Sunburn_percentarea.mean) ~ Treatment + Block, data = Data_test)
print(summary(model))
print(emmeans(model, list(pairwise ~ Treatment), adjust = "tukey"))
plot(model, 1)
plot(model, 2)


```

```{r Analysis: Table 3 Sticky card data (Spring)}

#NOTE! One card fell in the orchard (block 4 control June 16) and data were imputed from the three other control plots on that day (average of the three control plots was inserted into the excel file cell)

#Summary for table
Data_cards_spring_analyzed <- do.call(data.frame, 
             aggregate(cbind(PP,
                             Trech,
                             Derae,
                             Campy,
                             Coccinellidae,
                             Anthocoridae,
                             Black
                             )
                             ~Trt, 
                       data = Data_cards_spring_cumulative, 
                       function(x) 
                       c(mean = mean(x), 
                       SEM = sd(x)/sqrt(length(x)))))

#recode block as a factor, not a number
Data_cards_spring_cumulative$Block <- as.factor(Data_cards_spring_cumulative$Block)

#METHOD FOR PUBLICATION: 3a

#Method 1a. summary data, no transform, random block.
Data_test <- Data_cards_spring_cumulative

model <- glmmTMB(formula = PP ~ Trt + (1|Block), data = Data_test) #poor fit. P <0.01
plot(simulateResiduals(model))
print(Anova(model))
print(emmeans(model, list(pairwise ~ Trt), adjust = "tukey"))
model <- glmmTMB(formula = Trech ~ Trt + (1|Block), data = Data_test) #P < 0.01. Extenday lowest
plot(simulateResiduals(model))
print(Anova(model))
print(emmeans(model, list(pairwise ~ Trt), adjust = "tukey"))
model <- glmmTMB(formula = Campy ~ Trt + (1|Block), data = Data_test) #P < 0.01. Extenday highest
plot(simulateResiduals(model))
print(Anova(model))
print(emmeans(model, list(pairwise ~ Trt), adjust = "tukey"))

#Method 1b. summary data, log transform, random block.
Data_test <- Data_cards_spring_cumulative

model <- glmmTMB(formula = log(PP) ~ Trt + (1|Block), data = Data_test) #P <0.01
plot(simulateResiduals(model))
print(Anova(model))
print(emmeans(model, list(pairwise ~ Trt), adjust = "tukey"))
model <- glmmTMB(formula = log(Trech+1) ~ Trt + (1|Block), data = Data_test) #P < 0.01. Extenday lowest
plot(simulateResiduals(model))
print(Anova(model))
print(emmeans(model, list(pairwise ~ Trt), adjust = "tukey"))
model <- glmmTMB(formula = log(Campy) ~ Trt + (1|Block), data = Data_test) #P < 0.01. Extenday > Mylar
plot(simulateResiduals(model))
print(Anova(model))
print(emmeans(model, list(pairwise ~ Trt), adjust = "tukey"))

#Method 2. summary data, no transform, random block, lme.
Data_test <- Data_cards_spring_cumulative

model <- lme((PP) ~ Trt, random = ~1|Block, data = Data_test, method = "REML") #P = 0.02
plot(model)
qqnorm(resid(model))
print(anova(model))
print(emmeans(model, list(pairwise ~ Trt), adjust = "tukey"))
model <- lme((Trech) ~ Trt, random = ~1|Block, data = Data_test, method = "REML") #P = 0.02
plot(model)
qqnorm(resid(model))
print(anova(model))
print(emmeans(model, list(pairwise ~ Trt), adjust = "tukey"))
model <- lme((Campy) ~ Trt, random = ~1|Block, data = Data_test, method = "REML") #P = 0.02
plot(model)
qqnorm(resid(model))
print(anova(model))
print(emmeans(model, list(pairwise ~ Trt), adjust = "tukey"))

#Method 3a. summary data, no transform, fixed block.
Data_test <- Data_cards_spring_cumulative

model <- aov((PP) ~ Trt + Block, data = Data_test) #P = 0.02
print(summary(model))
print(emmeans(model, list(pairwise ~ Trt), adjust = "tukey"))
plot(model, 1)
plot(model, 2)
model <- aov((Trech) ~ Trt + Block, data = Data_test) #P = 0.01
print(summary(model))
print(emmeans(model, list(pairwise ~ Trt), adjust = "tukey"))
plot(model, 1)
plot(model, 2)
model <- aov((Campy) ~ Trt + Block, data = Data_test) #P = 0.01
print(summary(model))
print(emmeans(model, list(pairwise ~ Trt), adjust = "tukey"))
plot(model, 1)
plot(model, 2)

#Method 3b. summary data, no transform, fixed block.
Data_test <- Data_cards_spring_cumulative

model <- aov(log(PP) ~ Trt + Block, data = Data_test) #P < 0.01
print(summary(model))
print(emmeans(model, list(pairwise ~ Trt), adjust = "tukey"))
plot(model, 1)
plot(model, 2)
model <- aov(log(Trech+1) ~ Trt + Block, data = Data_test) #P < 0.01
print(summary(model))
print(emmeans(model, list(pairwise ~ Trt), adjust = "tukey"))
plot(model, 1)
plot(model, 2)
model <- aov(log(Campy) ~ Trt + Block, data = Data_test) #P = 0.05
print(summary(model))
print(emmeans(model, list(pairwise ~ Trt), adjust = "tukey"))
plot(model, 1)
plot(model, 2)




```

```{r Analysis: Table 3 Sticky card data (Fall)}

#summary for table
Data_cards_fall_analyzed <- do.call(data.frame, 
             aggregate(cbind(PP,
                             Trech,
                             Derae,
                             Campy,
                             Coccinellidae,
                             Anthocoridae,
                             Black
                             )
                             ~Trt, 
                       data = Data_cards_fall_cumulative, 
                       function(x) 
                       c(mean = mean(x), 
                       SEM = sd(x)/sqrt(length(x)))))

#recode block as a factor, not a number
Data_cards_fall_cumulative$Block <- as.factor(Data_cards_fall_cumulative$Block)


#METHOD FOR PUBLICATION: 3a

#Method 1a. summary data, no transform, random block.
Data_test <- Data_cards_fall_cumulative

model <- glmmTMB(formula = PP ~ Trt + (1|Block), data = Data_test) #no fit
plot(simulateResiduals(model))
print(Anova(model))
print(emmeans(model, list(pairwise ~ Trt), adjust = "tukey"))
model <- glmmTMB(formula = Trech ~ Trt + (1|Block), data = Data_test) #P < 0.01
plot(simulateResiduals(model))
print(Anova(model))
print(emmeans(model, list(pairwise ~ Trt), adjust = "tukey"))
model <- glmmTMB(formula = Campy ~ Trt + (1|Block), data = Data_test) #P = 0.3
plot(simulateResiduals(model))
print(Anova(model))
print(emmeans(model, list(pairwise ~ Trt), adjust = "tukey"))

#Method 1b. summary data, log transform, random block.
Data_test <- Data_cards_fall_cumulative

model <- glmmTMB(formula = log(PP) ~ Trt + (1|Block), data = Data_test) #P = 0.04
plot(simulateResiduals(model))
print(Anova(model))
print(emmeans(model, list(pairwise ~ Trt), adjust = "tukey"))
model <- glmmTMB(formula = log(Trech+1) ~ Trt + (1|Block), data = Data_test) #P < 0.01
plot(simulateResiduals(model))
print(Anova(model))
print(emmeans(model, list(pairwise ~ Trt), adjust = "tukey"))
model <- glmmTMB(formula = log(Campy+1) ~ Trt + (1|Block), data = Data_test) #P = 0.5
plot(simulateResiduals(model))
print(Anova(model))
print(emmeans(model, list(pairwise ~ Trt), adjust = "tukey"))

#Method 2. summary data, no transform, random block, lme.
Data_test <- Data_cards_fall_cumulative

model <- lme((PP) ~ Trt, random = ~1|Block, data = Data_test, method = "REML") #P = 0.2
plot(model)
qqnorm(resid(model))
print(anova(model))
print(emmeans(model, list(pairwise ~ Trt), adjust = "tukey"))
model <- lme((Trech) ~ Trt, random = ~1|Block, data = Data_test, method = "REML") #P = 0.09
plot(model)
qqnorm(resid(model))
print(anova(model))
print(emmeans(model, list(pairwise ~ Trt), adjust = "tukey"))
model <- lme((Campy) ~ Trt, random = ~1|Block, data = Data_test, method = "REML") #P = 0.4
plot(model)
qqnorm(resid(model))
print(anova(model))
print(emmeans(model, list(pairwise ~ Trt), adjust = "tukey"))

#Method 3a. summary data, no transform, fixed block.
Data_test <- Data_cards_fall_cumulative

model <- aov((PP) ~ Trt + Block, data = Data_test) #P = 0.3
print(summary(model))
print(emmeans(model, list(pairwise ~ Trt), adjust = "tukey"))
plot(model, 1)
plot(model, 2)
model <- aov((Trech) ~ Trt + Block, data = Data_test) #P = 0.09
print(summary(model))
print(emmeans(model, list(pairwise ~ Trt), adjust = "tukey"))
plot(model, 1)
plot(model, 2)
model <- aov((Campy) ~ Trt + Block, data = Data_test) #P = 0.4
print(summary(model))
print(emmeans(model, list(pairwise ~ Trt), adjust = "tukey"))
plot(model, 1)
plot(model, 2)

#Method 3b. summary data, log transform, fixed block.
Data_test <- Data_cards_fall_cumulative

model <- aov(log(PP) ~ Trt + Block, data = Data_test) #P = 0.2
print(summary(model))
print(emmeans(model, list(pairwise ~ Trt), adjust = "tukey"))
plot(model, 1)
plot(model, 2)
model <- aov(log(Trech+1) ~ Trt + Block, data = Data_test) #P = 0.07
print(summary(model))
print(emmeans(model, list(pairwise ~ Trt), adjust = "tukey"))
plot(model, 1)
plot(model, 2)
model <- aov(log(Campy+1) ~ Trt + Block, data = Data_test) #P = 0.6
print(summary(model))
print(emmeans(model, list(pairwise ~ Trt), adjust = "tukey"))
plot(model, 1)
plot(model, 2)



```

```{r Supplementary visualization: Sticky cards}

#Pear psylla adults
p_adultcards <- ggplot(Data_cards, aes(x = Day_mid, y = PP/Days, color = Trt, fill = Trt, shape = Trt)) +
  scale_fill_manual(values = c('black', 'white', 'grey')) +
  scale_color_manual(values = c('black', 'grey', 'black')) +
  scale_shape_manual(values = c(21,23,23)) +
  stat_summary(fun.data = mean_se, geom = "errorbar", width = 0, linetype = 'solid') +
  stat_summary(fun = "mean", geom = "line") +
  stat_summary(fun = "mean", geom = "point") +
  scale_x_continuous("Date",
                         breaks = c(182,213,244),
                         labels = c("1-Jul","1-Aug","1-Sep")) +
  geom_vline(xintercept = 220) #reflective groundcover removal

#Trechnites
p_trechcards <- ggplot(Data_cards, aes(x = Day_mid, y = Trech/Days, color = Trt, fill = Trt, shape = Trt)) +
  scale_fill_manual(values = c('black', 'white', 'grey')) +
  scale_color_manual(values = c('black', 'grey', 'black')) +
  scale_shape_manual(values = c(21,23,23)) +
  stat_summary(fun.data = mean_se, geom = "errorbar", width = 0, linetype = 'solid') +
  stat_summary(fun = "mean", geom = "line") +
  stat_summary(fun = "mean", geom = "point") +
  scale_x_continuous("Date",
                         breaks = c(182,213,244),
                         labels = c("1-Jul","1-Aug","1-Sep")) +
  geom_vline(xintercept = 220) #reflective groundcover removal

#Deraeocoris
p_derae <- ggplot(Data_cards, aes(x = Day_mid, y = Derae/Days, color = Trt, fill = Trt, shape = Trt)) +
  scale_fill_manual(values = c('black', 'white', 'grey')) +
  scale_color_manual(values = c('black', 'grey', 'black')) +
  scale_shape_manual(values = c(21,23,23)) +
  stat_summary(fun.data = mean_se, geom = "errorbar", width = 0, linetype = 'solid') +
  stat_summary(fun = "mean", geom = "line") +
  stat_summary(fun = "mean", geom = "point") +
  scale_x_continuous("Date",
                         breaks = c(182,213,244),
                         labels = c("1-Jul","1-Aug","1-Sep")) +
  geom_vline(xintercept = 220) #reflective groundcover removal

#Campylomma
p_campy <- ggplot(Data_cards, aes(x = Day_mid, y = Campy/Days, color = Trt, fill = Trt, shape = Trt)) +
  scale_fill_manual(values = c('black', 'white', 'grey')) +
  scale_color_manual(values = c('black', 'grey', 'black')) +
  scale_shape_manual(values = c(21,23,23)) +
  stat_summary(fun.data = mean_se, geom = "errorbar", width = 0, linetype = 'solid') +
  stat_summary(fun = "mean", geom = "line") +
  stat_summary(fun = "mean", geom = "point") +
  scale_x_continuous("Date",
                         breaks = c(182,213,244),
                         labels = c("1-Jul","1-Aug","1-Sep")) +
  geom_vline(xintercept = 220) #reflective groundcover removal

#Small black ladybugs
p_blacks <- ggplot(Data_cards, aes(x = Day_mid, y = Black/Days, color = Trt, fill = Trt, shape = Trt)) +
  scale_fill_manual(values = c('black', 'white', 'grey')) +
  scale_color_manual(values = c('black', 'grey', 'black')) +
  scale_shape_manual(values = c(21,23,23)) +
  stat_summary(fun.data = mean_se, geom = "errorbar", width = 0, linetype = 'solid') +
  stat_summary(fun = "mean", geom = "line") +
  stat_summary(fun = "mean", geom = "point") +
  scale_x_continuous("Date",
                         breaks = c(182,213,244),
                         labels = c("1-Jul","1-Aug","1-Sep")) +
  geom_vline(xintercept = 220) #reflective groundcover removal

  Fig2103_stickycard <- (ggarrange(
    p_adultcards,
    p_trechcards,
    p_campy,
    p_derae,
    p_blacks,
    ncol = 1,
    align="hv",common.legend = TRUE
    ))

```
